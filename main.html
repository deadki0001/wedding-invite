<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Our Wedding Celebration</title>
    <style>
        :root {
            --blush: #f8cfd5;
            --rose: #d46a7c;
            --burgundy: #7b1e3b;
            --gold: #d4af37;
            --white: #fff;
            --soft-pink: #fbeaea;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--soft-pink), var(--blush));
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        /* Carousel Container */
        .carousel-container {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            background: rgba(255,255,255,0.6);
        }

        .carousel {
            display: flex;
            height: 100%;
            transition: transform 0.6s cubic-bezier(.2,.8,.2,1);
            will-change: transform;
        }

        .carousel-slide {
            display: flex;
            min-width: 100%;
            height: 100%;
            gap: 10px;
            padding: 10px;
            align-items: stretch;
        }

        .carousel-item {
            flex: 1;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 15px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            transition: transform .3s ease, opacity .3s ease;
            background-color: var(--soft-pink);
            overflow: hidden;
        }

        /* OPTIMIZED Loading states with shimmer effect */
        .carousel-item.loading {
            background: linear-gradient(90deg, var(--blush), var(--rose), var(--blush));
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .carousel-item.loading::before {
            content: 'üíï';
            font-size: 2rem;
            animation: pulse 1.5s infinite;
        }

        /* OPTIMIZED Shimmer animation for faster perceived loading */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* OPTIMIZED Smooth fade-in for loaded images */
        .carousel-item.loaded { 
            opacity: 1;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; filter: blur(5px); }
            to { opacity: 1; filter: blur(0); }
        }

        .carousel-item.error {
            background: linear-gradient(135deg, var(--rose), var(--burgundy));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.25);
        }

        .carousel-item::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0) 40%, rgba(0,0,0,0.08) 100%);
            border-radius: 15px;
            pointer-events: none;
        }

        /* Navigation buttons */
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.25s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        .carousel-nav:hover { background: var(--gold); color: white; transform: translateY(-50%) scale(1.06); }

        .carousel-nav.prev { left: 16px; }
        .carousel-nav.next { right: 16px; }

        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 12px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(123, 30, 59, 0.28);
            cursor: pointer;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .dot.active { background: var(--gold); transform: scale(1.2); }

        /* Main Content */
        .main-content {
            padding: 2rem;
            text-align: center;
            max-width: 1000px;
            margin: 0 auto;
        }

        .welcome-message {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            backdrop-filter: blur(6px);
        }

        .welcome-message h1 {
            color: var(--burgundy);
            font-size: 2.4rem;
            margin-bottom: 0.6rem;
        }

        .welcome-message p { color: var(--rose); font-size: 1.1rem; line-height: 1.6; margin-bottom: .7rem; }

        .guest-name { color: var(--gold); font-weight: 700; font-size: 1.15rem; }

        /* RSVP Section */
        .rsvp-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 2rem 0;
            box-shadow: 0 6px 24px rgba(0,0,0,0.06);
        }

        .rsvp-buttons { display:flex; gap:1rem; justify-content:center; flex-wrap:wrap; margin-top:1rem; }

        .rsvp-btn { padding:.8rem 1.5rem; border:none; border-radius:25px; font-size:1rem; cursor:pointer; font-weight:700; min-width:120px; }
        .rsvp-btn.accept { background:var(--gold); color:white; }
        .rsvp-btn.decline { background:var(--rose); color:white; }

        .rsvp-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }

        /* Wedding Details */
        .wedding-details { background: rgba(255,255,255,0.92); border-radius:15px; padding:1.5rem; margin:2rem 0; box-shadow:0 6px 24px rgba(0,0,0,0.06); }
        .detail-item { margin:1rem 0; padding:1rem; background: rgba(212,175,55,0.08); border-radius:10px; border-left:4px solid var(--gold); }
        .detail-item h3 { color: var(--burgundy); margin-bottom:.3rem; }
        .detail-item p { color: var(--rose); }

        /* Floating Hearts */
        .heart { position: fixed; color: var(--rose); font-size: 20px; pointer-events: none; animation: float 6s linear infinite; opacity: 0; }
        @keyframes float { 0% { transform: translateY(100vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(-100px) rotate(360deg); opacity: 0; } }

        .logout-btn { position: fixed; top: 20px; right: 20px; background: var(--burgundy); color: white; border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-size: 0.9rem; z-index: 1000; }
        .logout-btn:hover { background: var(--rose); transform: scale(1.05); }

        /* Responsive */
        @media (max-width: 768px) {
            .carousel-container { height: 300px; }
            .carousel-slide { flex-direction: column; gap: 6px; }
            .carousel-item { min-height: 90px; }
            .welcome-message h1 { font-size: 1.9rem; }
            .main-content { padding: 1rem; }
            .carousel-nav { width: 40px; height: 40px; font-size: 20px; }
        }

        /* OPTIMIZED Preloader with your theme colors */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--soft-pink), var(--blush));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loader-content {
            text-align: center;
            color: var(--burgundy);
        }

        .loader-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .loader-spinner {
            font-size: 3rem;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* OPTIMIZED Progress bar for image loading */
        .loading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--blush);
            z-index: 9998;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--rose));
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- OPTIMIZED Page Loader with progress -->
    <div class="page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="loader-spinner">üíç</div>
            <h2>Preparing your beautiful memories...</h2>
            <div style="margin-top: 1rem; color: var(--rose);" id="loadingStatus">Loading images...</div>
        </div>
    </div>

    <!-- OPTIMIZED Loading progress bar -->
    <div class="loading-progress" id="loadingProgress">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <button class="logout-btn" onclick="logout()">üö™ Logout</button>

    <!-- Photo Carousel -->
    <div class="carousel-container" aria-roledescription="carousel">
        <button class="carousel-nav prev" aria-label="Previous" onclick="previousSlide()">‚Äπ</button>
        <button class="carousel-nav next" aria-label="Next" onclick="nextSlide()">‚Ä∫</button>

        <div class="carousel" id="photoCarousel" aria-live="polite" role="region">
            <!-- Slides will be dynamically created -->
        </div>

        <div class="carousel-dots" id="carouselDots" role="tablist" aria-label="Slide indicators"></div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="welcome-message">
            <h1>üíç Welcome to Our Wedding! üöÄ</h1>
            <p>Hello <span class="guest-name" id="guestName">Beautiful Soul</span>!</p>
            <p>We're absolutely thrilled to have you join us for the most epic wedding celebration this galaxy has ever seen! ‚ú®</p>
            <p>Get ready for a night filled with love, laughter, dancing, and memories that will last a lifetime! üéâ</p>
        </div>

        <div class="rsvp-section">
            <h2 style="color: var(--burgundy); margin-bottom: 1rem;">üìù RSVP</h2>
            <p style="color: var(--rose);">Will you be joining us on our special day?</p>
            <div class="rsvp-buttons">
                <button class="rsvp-btn accept" onclick="rsvp('accepted')">‚úÖ Yes, I'll be there!</button>
                <button class="rsvp-btn decline" onclick="rsvp('declined')">‚ùå Sorry, can't make it</button>
            </div>
            <div id="rsvpStatus" style="margin-top: 1rem; font-weight: bold;"></div>
        </div>

        <div class="wedding-details">
            <h2 style="color: var(--burgundy); margin-bottom: 1rem;">üìÖ Wedding Details</h2>
            <div class="detail-item">
                <h3>üìç Venue</h3>
                <p>Carmel Coastal Retreat<br>Garden Route, George</p>
            </div>
            <div class="detail-item">
                <h3>üìÖ Date & Time</h3>
                <p>Sunday, September 28th, 2025<br>12:00 PM - Afternoon</p>
            </div>
            <div class="detail-item">
                <h3>üëó Dress Code</h3>
                <p>Formal<br>Feel free to add some sparkle! ‚ú®</p>
            </div>
            <div class="detail-item">
                <h3>üéÅ Registry</h3>
                <p>Your presence is our present!<br>But if you insist, feel free</p>
            </div>
        </div>
    </div>

    <!-- Audio element for wedding music -->
    <audio id="weddingMusic" loop>
        <source src="assets/wedding-song.mp3" type="audio/mpeg" />
        Your browser does not support the audio element.
    </audio>

    <script>
        let currentGuest = null;
        let currentSlide = 0;
        let totalSlides = 0;
        let autoSlideInterval = null;
        let allPhotos = [];
        let photoSlides = [];
        let loadedImages = 0;
        let totalImages = 0;
        const assetsBase = 'assets/';
        const imageCache = new Map(); // OPTIMIZED: Image caching

        // OPTIMIZED: Your existing photos list (keeping all of them!)
        const availablePhotos = [
            'ring-hand.jpg', 'wedding1.jpg', 'wedding2.jpg', 'wedding3.jpg',
            'IMG_0269.jpg', 'IMG_0279.jpg', 'IMG_0282.jpg', 'IMG_0284.jpg',
            'IMG_0298.jpg', 'IMG_0315.jpg', 'IMG_0319.jpg', 'IMG_0321.jpg',
            'IMG_0322.jpg', 'IMG_0332.jpg', 'IMG_0338.jpg', 'IMG_0342.jpg',
            'IMG_0346.jpg', 'IMG_0353.jpg', 'IMG_0358.jpg', 'IMG_0361.jpg',
            'IMG_0362.jpg', 'IMG_0382.jpg', 'IMG_0385.jpg', 'IMG_0386.jpg',
            'IMG_0393.jpg', 'IMG_0394.jpg', 'IMG_0397.jpg', 'IMG_0400.jpg',
            'IMG_0405.jpg', 'IMG_0407.jpg', 'IMG_0409.jpg', 'IMG_0416.jpg',
            'IMG_0417.jpg', 'IMG_0418.jpg', 'IMG_0423.jpg', 'IMG_0424.jpg',
            'IMG_0431.jpg', 'IMG_0436.jpg', 'IMG_0439.jpg', 'IMG_0440.jpg',
            'IMG_0442.jpg', 'IMG_0446.jpg', 'IMG_0448.jpg', 'IMG_0451.jpg',
            'IMG_0458.jpg', 'IMG_0467.jpg', 'IMG_0470.jpg', 'IMG_0471.jpg',
            'IMG_0472.jpg', 'IMG_0473.jpg', 'IMG_0475.jpg', 'IMG_0478.jpg',
            'IMG_0481.jpg', 'IMG_0483.jpg', 'IMG_0487.jpg', 'IMG_0489.jpg',
            'IMG_0493.jpg', 'IMG_0502.jpg', 'IMG_0504.jpg', 'IMG_0505.jpg',
            'IMG_0507.jpg', 'IMG_0508.jpg', 'IMG_0511.jpg', 'IMG_0515.jpg',
            'IMG_0522.jpg', 'IMG_0548.jpg', 'IMG_0551.jpg', 'IMG_0552.jpg',
            'IMG_0559.jpg', 'IMG_0560.jpg', 'IMG_0565.jpg', 'IMG_0566.jpg',
            'IMG_0570.jpg', 'IMG_0572.jpg', 'IMG_0576.jpg', 'IMG_0579.jpg',
            'IMG_0580.jpg', 'IMG_0583.jpg', 'IMG_0588.jpg', 'IMG_0589.jpg',
            'IMG_0596.jpg', 'IMG_0606.jpg', 'IMG_0614.jpg', 'IMG_0616.jpg'
        ];

        /* OPTIMIZED: Progressive image loading with smart prioritization */
        function initializeCarousel() {
            // Priority photos load first (hero images)
            const priority = ['ring-hand.jpg', 'wedding1.jpg', 'wedding2.jpg', 'wedding3.jpg'];
            const priorityPhotos = priority.filter(p => availablePhotos.includes(p));
            const otherPhotos = availablePhotos.filter(p => !priority.includes(p));
            
            // Shuffle other photos for variety
            for (let i = otherPhotos.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [otherPhotos[i], otherPhotos[j]] = [otherPhotos[j], otherPhotos[i]];
            }
            
            allPhotos = [...priorityPhotos, ...otherPhotos];
            totalImages = allPhotos.length;

            // Group into slides of 3
            photoSlides = [];
            for (let i = 0; i < allPhotos.length; i += 3) {
                photoSlides.push(allPhotos.slice(i, i + 3));
            }
            totalSlides = photoSlides.length;

            // Create carousel HTML
            const carousel = document.getElementById('photoCarousel');
            carousel.innerHTML = '';

            photoSlides.forEach((slidePhotos, slideIndex) => {
                const slide = document.createElement('div');
                slide.className = 'carousel-slide';
                slide.setAttribute('data-slide', slideIndex);

                slidePhotos.forEach((photo, photoIndex) => {
                    const item = document.createElement('div');
                    item.className = 'carousel-item loading';
                    item.setAttribute('data-photo', photo);
                    item.setAttribute('role', 'img');
                    item.setAttribute('aria-label', `Photo ${slideIndex * 3 + photoIndex + 1}`);
                    slide.appendChild(item);
                });

                carousel.appendChild(slide);
            });

            createDots();
            
            // OPTIMIZED: Start aggressive loading strategy
            startOptimizedLoading();
        }

        /* OPTIMIZED: Smart loading strategy */
        function startOptimizedLoading() {
            // Step 1: Load first slide immediately
            loadSlideImmediate(0);
            
            // Step 2: Preload priority images in background
            setTimeout(() => {
                preloadCriticalImages();
            }, 100);
            
            // Step 3: Load remaining slides progressively
            setTimeout(() => {
                loadRemainingSlides();
            }, 500);
            
            // Step 4: Start auto-slide once first slide is loaded
            setTimeout(() => {
                startAutoSlide();
                updateLoadingProgress(25);
            }, 800);
        }

        /* OPTIMIZED: Immediate loading for first slide */
        function loadSlideImmediate(slideIndex) {
            const slide = document.querySelector(`.carousel-slide[data-slide="${slideIndex}"]`);
            if (!slide) return;

            const items = slide.querySelectorAll('.carousel-item.loading');
            
            items.forEach((item, index) => {
                const photo = item.getAttribute('data-photo');
                
                // Load with priority and timeout
                loadImageOptimized(photo, item, index * 100);
            });
        }

        /* OPTIMIZED: Enhanced image loading function */
        function loadImageOptimized(photo, item, delay = 0) {
            setTimeout(() => {
                // Check cache first
                if (imageCache.has(photo)) {
                    applyImageToElement(item, imageCache.get(photo));
                    return;
                }

                const img = new Image();
                const photoUrl = assetsBase + photo;
                
                // Set loading timeout
                const timeout = setTimeout(() => {
                    item.classList.remove('loading');
                    item.classList.add('error');
                    item.textContent = 'üíï Beautiful Memory';
                    updateLoadingProgress();
                }, 8000); // 8 second timeout

                img.onload = function() {
                    clearTimeout(timeout);
                    
                    // Cache the loaded image
                    imageCache.set(photo, photoUrl);
                    
                    applyImageToElement(item, photoUrl);
                    updateLoadingProgress();
                };
                
                img.onerror = function() {
                    clearTimeout(timeout);
                    item.classList.remove('loading');
                    item.classList.add('error');
                    item.textContent = 'üíï Beautiful Memory';
                    updateLoadingProgress();
                };
                
                // Start loading with priority hints
                img.loading = 'eager';
                img.fetchPriority = 'high';
                img.src = photoUrl;
                
            }, delay);
        }

        /* OPTIMIZED: Apply image with smooth transition */
        function applyImageToElement(item, imageUrl) {
            item.style.backgroundImage = `url('${imageUrl}')`;
            item.classList.remove('loading');
            item.classList.add('loaded');
        }

        /* OPTIMIZED: Preload critical images */
        function preloadCriticalImages() {
            const criticalPhotos = allPhotos.slice(0, 9); // First 3 slides
            
            criticalPhotos.forEach((photo, index) => {
                if (!imageCache.has(photo)) {
                    setTimeout(() => {
                        const img = new Image();
                        img.onload = () => {
                            imageCache.set(photo, assetsBase + photo);
                            updateLoadingProgress();
                        };
                        img.src = assetsBase + photo;
                    }, index * 50); // Staggered loading
                }
            });
        }

        /* OPTIMIZED: Load remaining slides progressively */
        function loadRemainingSlides() {
            for (let i = 1; i < totalSlides; i++) {
                setTimeout(() => {
                    loadSlide(i);
                }, i * 300); // Load every 300ms
            }
        }

        /* OPTIMIZED: Progress tracking */
        function updateLoadingProgress(forcePercent = null) {
            if (forcePercent !== null) {
                loadedImages = Math.floor((forcePercent / 100) * totalImages);
            } else {
                loadedImages++;
            }
            
            const progress = Math.min((loadedImages / totalImages) * 100, 100);
            
            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            
            // Update loading status
            const loadingStatus = document.getElementById('loadingStatus');
            if (loadingStatus) {
                loadingStatus.textContent = `Loading ${Math.round(progress)}% complete...`;
            }
            
            // Hide loaders when complete
            if (progress >= 90) {
                setTimeout(() => hideLoaders(), 500);
            }
        }

        /* OPTIMIZED: Hide loading screens */
        function hideLoaders() {
            const pageLoader = document.getElementById('pageLoader');
            const progressLoader = document.getElementById('loadingProgress');
            
            if (pageLoader) {
                pageLoader.style.opacity = '0';
                setTimeout(() => {
                    pageLoader.style.display = 'none';
                }, 500);
            }
            
            if (progressLoader) {
                progressLoader.style.opacity = '0';
                setTimeout(() => {
                    progressLoader.style.display = 'none';
                }, 500);
            }
        }

        /* OPTIMIZED: Enhanced slide loading */
        function loadSlide(slideIndex) {
            const slide = document.querySelector(`.carousel-slide[data-slide="${slideIndex}"]`);
            if (!slide) return;

            const items = slide.querySelectorAll('.carousel-item.loading');
            
            items.forEach((item, index) => {
                const photo = item.getAttribute('data-photo');
                loadImageOptimized(photo, item, index * 100);
            });
        }

        /* OPTIMIZED: Smart preloading for upcoming slides */
        function preloadSlides() {
            // Preload next 2 slides with lower priority
            const nextSlides = [
                (currentSlide + 1) % totalSlides,
                (currentSlide + 2) % totalSlides
            ];
            
            nextSlides.forEach((slideIndex, priority) => {
                setTimeout(() => {
                    const slide = document.querySelector(`.carousel-slide[data-slide="${slideIndex}"]`);
                    if (!slide) return;
                    
                    const unloadedItems = slide.querySelectorAll('.carousel-item.loading');
                    unloadedItems.forEach(item => {
                        const photo = item.getAttribute('data-photo');
                        if (!imageCache.has(photo)) {
                            loadImageOptimized(photo, item, priority * 200);
                        }
                    });
                }, priority * 100);
            });
        }

        /* Navigation functions (keeping your existing logic) */
        function createDots() {
            const dotsContainer = document.getElementById('carouselDots');
            dotsContainer.innerHTML = '';
            
            for (let i = 0; i < totalSlides; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                if (i === 0) dot.classList.add('active');
                dot.addEventListener('click', () => goToSlide(i));
                dotsContainer.appendChild(dot);
            }
        }

        function nextSlide() {
            currentSlide = (currentSlide + 1) % totalSlides;
            updateCarousel();
        }

        function previousSlide() {
            currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
            updateCarousel();
        }

        function goToSlide(slideIndex) {
            currentSlide = slideIndex;
            updateCarousel();
        }

        function updateCarousel() {
            const carousel = document.getElementById('photoCarousel');
            carousel.style.transform = `translateX(-${currentSlide * 100}%)`;
            
            // Update dots
            document.querySelectorAll('.dot').forEach((dot, index) => {
                dot.classList.toggle('active', index === currentSlide);
            });
            
            // Load current slide if not loaded
            loadSlide(currentSlide);
            
            // Preload upcoming slides
            setTimeout(() => preloadSlides(), 100);
            
            restartAutoSlide();
        }

        function startAutoSlide() {
            autoSlideInterval = setInterval(nextSlide, 4000);
        }

        function restartAutoSlide() {
            clearInterval(autoSlideInterval);
            startAutoSlide();
        }

        /* RSVP Functions (keeping your existing logic) */
        async function rsvp(status) {
            if (!currentGuest) return;
            
            try {
                const response = await fetch('/api/rsvp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phone: currentGuest.phone, 
                        status: status 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentGuest.rsvp_status = status;
                    sessionStorage.setItem('currentGuest', JSON.stringify(currentGuest));
                    updateRSVPStatus();
                    
                    if (status === 'accepted') {
                        showConfetti();
                        alert("üéâ Thank you! We can't wait to celebrate with you!");
                    } else {
                        alert("üíî We'll miss you, but we understand!");
                    }
                } else {
                    throw new Error(result.error || 'Failed to save RSVP');
                }
            } catch (error) {
                console.warn('RSVP API failed, using offline mode:', error);
                
                // Offline fallback
                currentGuest.rsvp_status = status;
                sessionStorage.setItem('currentGuest', JSON.stringify(currentGuest));
                updateRSVPStatus();
                
                if (status === 'accepted') {
                    showConfetti();
                    alert("üéâ Thank you! (Saved locally - will sync when online)");
                } else {
                    alert("üíî We'll miss you! (Saved locally - will sync when online)");
                }
            }
        }

        function updateRSVPStatus() {
            const statusDiv = document.getElementById('rsvpStatus');
            const status = currentGuest?.rsvp_status;
            
            if (status === 'accepted') {
                statusDiv.innerHTML = '‚úÖ You\'re coming! We\'re so excited!';
                statusDiv.style.color = 'var(--gold)';
            } else if (status === 'declined') {
                statusDiv.innerHTML = '‚ùå You\'ll be missed!';
                statusDiv.style.color = 'var(--rose)';
            } else {
                statusDiv.innerHTML = '‚è≥ Please let us know if you can make it!';
                statusDiv.style.color = 'var(--burgundy)';
            }
        }

        /* Visual Effects (keeping your existing logic) */
        function showConfetti() {
            for (let i = 0; i < 30; i++) {
                setTimeout(() => createConfetti(), i * 100);
            }
        }

        function createConfetti() {
            const emojis = ['üéâ', 'üéä', '‚ú®', 'üí´', 'üåü', 'üíç', 'üíï'];
            const confetti = document.createElement('div');
            
            confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            confetti.style.cssText = `
                position: fixed;
                left: ${Math.random() * 100}vw;
                top: -10px;
                font-size: ${15 + Math.random() * 25}px;
                pointer-events: none;
                z-index: 9999;
                animation: fall ${3 + Math.random() * 2}s linear forwards;
            `;
            
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 6000);
        }

        function startFloatingHearts() {
            setInterval(() => {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.textContent = Math.random() > 0.5 ? 'üíï' : 'üíñ';
                heart.style.left = Math.random() * 100 + 'vw';
                heart.style.fontSize = (15 + Math.random() * 20) + 'px';
                heart.style.animationDuration = (4 + Math.random() * 3) + 's';
                document.body.appendChild(heart);
                setTimeout(() => heart.remove(), 8000);
            }, 2000);
        }

        function playWeddingMusic() {
            const audio = document.getElementById('weddingMusic');
            audio.volume = 0.3;
            audio.play().catch(() => {
                // Create music enable button if autoplay fails
                const musicBtn = document.createElement('button');
                musicBtn.textContent = 'üéµ Enable Music';
                musicBtn.style.cssText = `
                    position: fixed; top: 70px; right: 20px; 
                    background: var(--gold); color: white; 
                    border: none; padding: 0.5rem 1rem; 
                    border-radius: 20px; z-index: 1000; cursor: pointer;
                `;
                musicBtn.onclick = () => {
                    audio.play();
                    musicBtn.remove();
                };
                document.body.appendChild(musicBtn);
            });
        }

        function logout() {
            sessionStorage.removeItem('currentGuest');
            window.location.href = 'index.html';
        }

        /* OPTIMIZED: Page Initialization */
        window.addEventListener('DOMContentLoaded', function() {
            // Check for guest data
            const guestData = sessionStorage.getItem('currentGuest');
            if (!guestData) {
                window.location.href = 'index.html';
                return;
            }
            
            currentGuest = JSON.parse(guestData);
            document.getElementById('guestName').textContent = currentGuest.name || 'Beautiful Soul';
            
            // OPTIMIZED: Initialize everything with progressive loading
            updateLoadingProgress(10); // Initial progress
            
            // Initialize carousel with optimized loading
            setTimeout(() => {
                initializeCarousel();
                updateLoadingProgress(20);
            }, 100);
            
            // Initialize other features
            setTimeout(() => {
                updateRSVPStatus();
                updateLoadingProgress(30);
            }, 200);
            
            setTimeout(() => {
                playWeddingMusic();
                startFloatingHearts();
                updateLoadingProgress(40);
            }, 300);
        });

        // Keyboard navigation (keeping your existing logic)
        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') previousSlide();
            if (e.key === 'ArrowRight') nextSlide();
        });

        // OPTIMIZED: Performance monitoring
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearInterval(autoSlideInterval);
                // Pause any ongoing loading to save bandwidth
            } else {
                restartAutoSlide();
                // Resume loading if needed
                if (loadedImages < totalImages) {
                    setTimeout(() => loadRemainingSlides(), 1000);
                }
            }
        });

        // OPTIMIZED: Hover pause with image preloading
        const container = document.querySelector('.carousel-container');
        if (container) {
            container.addEventListener('mouseenter', () => {
                clearInterval(autoSlideInterval);
                // Preload adjacent slides on hover
                preloadSlides();
            });
            container.addEventListener('mouseleave', () => restartAutoSlide());
        }

        // Add CSS for confetti animation (keeping your existing animation)
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fall {
                to { 
                    transform: translateY(110vh) rotate(720deg); 
                    opacity: 0; 
                }
            }
        `;
        document.head.appendChild(style);

        // OPTIMIZED: Image compression hint for browsers
        if ('loading' in HTMLImageElement.prototype) {
            console.log('‚úÖ Native lazy loading supported');
        } else {
            console.log('‚ö†Ô∏è Using custom loading strategy');
        }

        // OPTIMIZED: Memory management
        window.addEventListener('beforeunload', () => {
            clearInterval(autoSlideInterval);
            imageCache.clear();
        });
    </script>
</body>
</html>