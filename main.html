<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Our Wedding Celebration</title>
    <style>
        :root {
            --blush: #f8cfd5;
            --rose: #d46a7c;
            --burgundy: #7b1e3b;
            --gold: #d4af37;
            --white: #fff;
            --soft-pink: #fbeaea;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--soft-pink), var(--blush));
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        /* OPTIMIZED: Intersection Observer loading states */
        .carousel-container {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            background: rgba(255,255,255,0.6);
        }

        .carousel {
            display: flex;
            height: 100%;
            transition: transform 0.6s cubic-bezier(.2,.8,.2,1);
            will-change: transform;
        }

        .carousel-slide {
            display: flex;
            min-width: 100%;
            height: 100%;
            gap: 10px;
            padding: 10px;
            align-items: stretch;
        }

        .carousel-item {
            flex: 1;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 15px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            transition: transform .3s ease, opacity .3s ease;
            background-color: var(--soft-pink);
            overflow: hidden;
        }

        /* OPTIMIZED: WebP support detection and low-res preview */
        .carousel-item.loading {
            background: linear-gradient(90deg, var(--blush), var(--rose), var(--blush));
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .carousel-item.loading::before {
            content: '💕';
            font-size: 2rem;
            animation: pulse 1.5s infinite;
        }

        /* OPTIMIZED: Blur-up effect for progressive loading */
        .carousel-item.preview {
            filter: blur(5px);
            transform: scale(1.05);
        }

        .carousel-item.loaded { 
            opacity: 1;
            filter: none;
            transform: scale(1);
            animation: sharpLoad 0.6s ease;
        }

        @keyframes sharpLoad {
            from { filter: blur(5px); transform: scale(1.05); }
            to { filter: blur(0); transform: scale(1); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .carousel-item.error {
            background: linear-gradient(135deg, var(--rose), var(--burgundy));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.25);
        }

        .carousel-item::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0) 40%, rgba(0,0,0,0.08) 100%);
            border-radius: 15px;
            pointer-events: none;
        }

        /* Navigation buttons */
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.25s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        .carousel-nav:hover { background: var(--gold); color: white; transform: translateY(-50%) scale(1.06); }

        .carousel-nav.prev { left: 16px; }
        .carousel-nav.next { right: 16px; }

        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 12px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(123, 30, 59, 0.28);
            cursor: pointer;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .dot.active { background: var(--gold); transform: scale(1.2); }

        /* Main Content */
        .main-content {
            padding: 2rem;
            text-align: center;
            max-width: 1000px;
            margin: 0 auto;
        }

        .welcome-message {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            backdrop-filter: blur(6px);
        }

        .welcome-message h1 {
            color: var(--burgundy);
            font-size: 2.4rem;
            margin-bottom: 0.6rem;
        }

        .welcome-message p { color: var(--rose); font-size: 1.1rem; line-height: 1.6; margin-bottom: .7rem; }

        .guest-name { color: var(--gold); font-weight: 700; font-size: 1.15rem; }

        /* RSVP Section */
        .rsvp-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 2rem 0;
            box-shadow: 0 6px 24px rgba(0,0,0,0.06);
        }

        .rsvp-buttons { display:flex; gap:1rem; justify-content:center; flex-wrap:wrap; margin-top:1rem; }

        .rsvp-btn { padding:.8rem 1.5rem; border:none; border-radius:25px; font-size:1rem; cursor:pointer; font-weight:700; min-width:120px; }
        .rsvp-btn.accept { background:var(--gold); color:white; }
        .rsvp-btn.decline { background:var(--rose); color:white; }

        .rsvp-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }

        /* Wedding Details */
        .wedding-details { background: rgba(255,255,255,0.92); border-radius:15px; padding:1.5rem; margin:2rem 0; box-shadow:0 6px 24px rgba(0,0,0,0.06); }
        .detail-item { margin:1rem 0; padding:1rem; background: rgba(212,175,55,0.08); border-radius:10px; border-left:4px solid var(--gold); }
        .detail-item h3 { color: var(--burgundy); margin-bottom:.3rem; }
        .detail-item p { color: var(--rose); }

        /* Floating Hearts */
        .heart { position: fixed; color: var(--rose); font-size: 20px; pointer-events: none; animation: float 6s linear infinite; opacity: 0; }
        @keyframes float { 0% { transform: translateY(100vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(-100px) rotate(360deg); opacity: 0; } }

        .logout-btn { position: fixed; top: 20px; right: 20px; background: var(--burgundy); color: white; border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-size: 0.9rem; z-index: 1000; }
        .logout-btn:hover { background: var(--rose); transform: scale(1.05); }

        /* Responsive */
        @media (max-width: 768px) {
            .carousel-container { height: 300px; }
            .carousel-slide { flex-direction: column; gap: 6px; }
            .carousel-item { min-height: 90px; }
            .welcome-message h1 { font-size: 1.9rem; }
            .main-content { padding: 1rem; }
            .carousel-nav { width: 40px; height: 40px; font-size: 20px; }
        }

        /* OPTIMIZED: Loading with bandwidth detection */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--soft-pink), var(--blush));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loader-content {
            text-align: center;
            color: var(--burgundy);
        }

        .loader-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .loader-spinner {
            font-size: 3rem;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--blush);
            z-index: 9998;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--rose));
            width: 0%;
            transition: width 0.3s ease;
        }

        /* OPTIMIZED: Connection indicator */
        .connection-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-indicator.fast {
            background: var(--gold);
            color: white;
        }

        .connection-indicator.slow {
            background: var(--rose);
            color: white;
        }

        .connection-indicator.offline {
            background: var(--burgundy);
            color: white;
        }
    </style>
</head>
<body>
    <!-- OPTIMIZED: Smart loader with connection detection -->
    <div class="page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="loader-spinner">💍</div>
            <h2>Preparing our beautiful memories...</h2>
            <div style="margin-top: 1rem; color: var(--rose);" id="loadingStatus">Loading images...</div>
            <div style="margin-top: 0.5rem; font-size: 0.9rem;" id="connectionInfo">Optimizing for your connection...</div>
        </div>
    </div>

    <!-- OPTIMIZED: Enhanced progress bar -->
    <div class="loading-progress" id="loadingProgress">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- Connection indicator -->
    <div class="connection-indicator" id="connectionIndicator" style="display: none;">
        <span id="connectionText">📶 Connection: Good</span>
    </div>

    <button class="logout-btn" onclick="logout()">🚪 Logout</button>

    <!-- Photo Carousel -->
    <div class="carousel-container" aria-roledescription="carousel">
        <button class="carousel-nav prev" aria-label="Previous" onclick="previousSlide()">‹</button>
        <button class="carousel-nav next" aria-label="Next" onclick="nextSlide()">›</button>

        <div class="carousel" id="photoCarousel" aria-live="polite" role="region">
            <!-- Slides will be dynamically created -->
        </div>

        <div class="carousel-dots" id="carouselDots" role="tablist" aria-label="Slide indicators"></div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="welcome-message">
            <h1>💍 Welcome to Our Wedding! 🚀</h1>
            <p>Hello <span class="guest-name" id="guestName">Beautiful Soul</span>!</p>
            <p>We're absolutely thrilled to have you join us for the most epic wedding celebration this galaxy has ever seen! ✨</p>
            <p>Get ready for a day filled with love, laughter, dancing, and memories that will last a lifetime! 🎉</p>
        </div>

        <div class="rsvp-section">
            <h2 style="color: var(--burgundy); margin-bottom: 1rem;">📝 RSVP</h2>
            <p style="color: var(--rose);">Will you be joining us on our special day?</p>
            <div class="rsvp-buttons">
                <button class="rsvp-btn accept" onclick="rsvp('accepted')">✅ Yes, I'll be there!</button>
                <button class="rsvp-btn decline" onclick="rsvp('declined')">❌ Sorry, can't make it</button>
            </div>
            <div id="rsvpStatus" style="margin-top: 1rem; font-weight: bold;"></div>
        </div>

        <div class="wedding-details">
            <h2 style="color: var(--burgundy); margin-bottom: 1rem;">📅 Wedding Details</h2>
            <div class="detail-item">
                <h3>📍 Venue</h3>
                <p>Carmel Coastal Retreat<br>Garden Route, George</p>
            </div>
            <div class="detail-item">
                <h3>📅 Date & Time</h3>
                <p>Sunday, September 28th, 2025<br>12:00 PM - Afternoon</p>
            </div>
            <div class="detail-item">
                <h3>👗 Dress Code</h3>
                <p>Formal<br>Feel free to add some sparkle! ✨</p>
            </div>
            <div class="detail-item">
                <h3>🎁 Registry</h3>
                <p>Your presence is our present!<br>But if you insist, feel free</p>
            </div>
        </div>
    </div>

    <!-- Audio element for wedding music -->
    <audio id="weddingMusic" loop>
        <source src="assets/wedding-song.mp3" type="audio/mpeg" />
        Your browser does not support the audio element.
    </audio>

    <script>
        let currentGuest = null;
        let currentSlide = 0;
        let totalSlides = 0;
        let autoSlideInterval = null;
        let allPhotos = [];
        let photoSlides = [];
        let loadedImages = 0;
        let totalImages = 0;
        let connectionSpeed = 'unknown';
        let loadingStrategy = 'adaptive';
        const assetsBase = 'assets/';
        
        // OPTIMIZED: Enhanced caching with compression hints
        const imageCache = new Map();
        const compressionSupport = {
            webp: false,
            avif: false
        };

        // OPTIMIZED: Your photo list
        const availablePhotos = [
            'pic1.png', 'pic2.png', 'pic3.png', 'pic4.png', 'pic5.png', 'pic6.png', 'pic7.png', 'pic8.png',
            'pic9.png', 'pic10.png', 'pic11.png', 'pic12.png', 'pic13.png', 'pic14.png', 'pic15.png',
            'pic17.png', 'pic18.png', 'pic19.png', 'pic20.png', 'pic21.png', 'pic22.png', 'pic23.png',
            'pic25.png', 'pic26.png', 'pic28.png', 'pic31.png', 'pic33.png', 'pic34.png', 'pic35.png',
            'pic36.png', 'pic37.png', 'pic38.png', 'pic39.png', 'pic40.png', 'pic41.png', 'pic43.png'
        ];

        // OPTIMIZED: Connection and format detection
        async function detectOptimalSettings() {
            // Test modern image format support
            try {
                compressionSupport.webp = await testImageFormat('webp');
                compressionSupport.avif = await testImageFormat('avif');
            } catch (e) {
                console.log('Format detection failed, using PNG');
            }

            // Detect connection speed
            if ('connection' in navigator) {
                const conn = navigator.connection;
                const effectiveType = conn.effectiveType;
                connectionSpeed = effectiveType;
                
                updateConnectionIndicator(effectiveType);
                
                // Adjust strategy based on connection
                if (effectiveType === '4g') {
                    loadingStrategy = 'aggressive';
                } else if (effectiveType === '3g') {
                    loadingStrategy = 'moderate';
                } else if (effectiveType === '2g' || effectiveType === 'slow-2g') {
                    loadingStrategy = 'conservative';
                } else {
                    loadingStrategy = 'adaptive';
                }
                
                updateLoadingStatus(`Connection: ${effectiveType.toUpperCase()}, Strategy: ${loadingStrategy}`);
            }

            // Estimate bandwidth with small test image
            try {
                await estimateBandwidth();
            } catch (e) {
                console.log('Bandwidth estimation failed');
            }
        }

        async function testImageFormat(format) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                
                const testImages = {
                    webp: 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA',
                    avif: 'data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAACAAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI='
                };
                
                img.src = testImages[format];
            });
        }

        async function estimateBandwidth() {
            const start = performance.now();
            
            // Create a small test image (1KB)
            const testImg = new Image();
            const testUrl = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
            
            return new Promise((resolve) => {
                testImg.onload = () => {
                    const loadTime = performance.now() - start;
                    const estimatedBandwidth = loadTime < 50 ? 'fast' : loadTime < 200 ? 'medium' : 'slow';
                    
                    if (estimatedBandwidth === 'slow') {
                        loadingStrategy = 'conservative';
                    }
                    
                    resolve(estimatedBandwidth);
                };
                
                testImg.src = testUrl;
            });
        }

        function updateConnectionIndicator(type) {
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            
            setTimeout(() => {
                indicator.style.display = 'block';
                
                if (type === '4g' || type === 'wifi') {
                    indicator.className = 'connection-indicator fast';
                    text.textContent = '📶 Connection: Excellent';
                } else if (type === '3g') {
                    indicator.className = 'connection-indicator slow';
                    text.textContent = '📶 Connection: Good';
                } else {
                    indicator.className = 'connection-indicator offline';
                    text.textContent = '📶 Connection: Limited';
                }
                
                setTimeout(() => {
                    indicator.style.opacity = '0';
                }, 3000);
            }, 2000);
        }

        function updateLoadingStatus(message) {
            const status = document.getElementById('connectionInfo');
            if (status) {
                status.textContent = message;
            }
        }

        // OPTIMIZED: Adaptive carousel initialization
        function initializeCarousel() {
            allPhotos = [...availablePhotos];
            totalImages = allPhotos.length;

            // Adaptive shuffling based on connection
            if (loadingStrategy === 'conservative') {
                // Load only first 12 images for slow connections
                allPhotos = allPhotos.slice(0, 12);
                totalImages = allPhotos.length;
            } else {
                // Shuffle for variety on faster connections
                for (let i = allPhotos.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allPhotos[i], allPhotos[j]] = [allPhotos[j], allPhotos[i]];
                }
            }

            // Group into slides (adaptive sizing)
            const itemsPerSlide = loadingStrategy === 'conservative' ? 2 : 3;
            photoSlides = [];
            for (let i = 0; i < allPhotos.length; i += itemsPerSlide) {
                photoSlides.push(allPhotos.slice(i, i + itemsPerSlide));
            }
            totalSlides = photoSlides.length;

            // Create carousel HTML
            const carousel = document.getElementById('photoCarousel');
            carousel.innerHTML = '';

            photoSlides.forEach((slidePhotos, slideIndex) => {
                const slide = document.createElement('div');
                slide.className = 'carousel-slide';
                slide.setAttribute('data-slide', slideIndex);

                slidePhotos.forEach((photo, photoIndex) => {
                    const item = document.createElement('div');
                    item.className = 'carousel-item loading';
                    item.setAttribute('data-photo', photo);
                    item.setAttribute('role', 'img');
                    item.setAttribute('aria-label', `Photo ${slideIndex * itemsPerSlide + photoIndex + 1}`);
                    slide.appendChild(item);
                });

                carousel.appendChild(slide);
            });

            createDots();
            startOptimizedLoading();
        }

        // OPTIMIZED: Intersection Observer for lazy loading
        function createIntersectionObserver() {
            const options = {
                root: null,
                rootMargin: '50px',
                threshold: 0.1
            };

            return new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const item = entry.target;
                        if (item.classList.contains('loading')) {
                            const photo = item.getAttribute('data-photo');
                            loadImageOptimized(photo, item);
                        }
                    }
                });
            }, options);
        }

        // OPTIMIZED: Smart loading with multiple strategies
        function startOptimizedLoading() {
            const observer = createIntersectionObserver();
            
            // Strategy 1: Load visible slide immediately
            loadSlideImmediate(0);
            
            // Strategy 2: Setup intersection observer for lazy loading
            document.querySelectorAll('.carousel-item.loading').forEach(item => {
                observer.observe(item);
            });
            
            // Strategy 3: Progressive background loading
            if (loadingStrategy === 'aggressive') {
                setTimeout(() => loadAllSlides(), 1000);
            } else if (loadingStrategy === 'moderate') {
                setTimeout(() => loadAdjacentSlides(), 2000);
            }
            
            // Start auto-slide after initial load
            setTimeout(() => {
                startAutoSlide();
                updateLoadingProgress(30);
            }, 1500);
        }

        function loadSlideImmediate(slideIndex) {
            const slide = document.querySelector(`.carousel-slide[data-slide="${slideIndex}"]`);
            if (!slide) return;

            const items = slide.querySelectorAll('.carousel-item.loading');
            items.forEach((item, index) => {
                const photo = item.getAttribute('data-photo');
                setTimeout(() => {
                    loadImageOptimized(photo, item, true);
                }, index * 100);
            });
        }

        function loadAdjacentSlides() {
            const adjacentSlides = [
                Math.max(0, currentSlide - 1),
                Math.min(totalSlides - 1, currentSlide + 1)
            ];
            
            adjacentSlides.forEach((slideIndex, priority) => {
                setTimeout(() => {
                    loadSlide(slideIndex);
                }, priority * 500);
            });
        }

        function loadAllSlides() {
            for (let i = 1; i < totalSlides; i++) {
                setTimeout(() => {
                    loadSlide(i);
                }, i * 300);
            }
        }

        // OPTIMIZED: Enhanced image loading with retry and fallback
        function loadImageOptimized(photo, item, highPriority = false) {
            if (imageCache.has(photo)) {
                applyImageToElement(item, imageCache.get(photo));
                return;
            }

            const img = new Image();
            const photoUrl = assetsBase + photo;
            let retryCount = 0;
            const maxRetries = 3;
            
            function attemptLoad() {
                const timeout = setTimeout(() => {
                    img.src = ''; // Cancel loading
                    if (retryCount < maxRetries) {
                        retryCount++;
                        setTimeout(attemptLoad, 1000 * retryCount);
                    } else {
                        showImageError(item);
                    }
                }, highPriority ? 8000 : 12000);

                img.onload = function() {
                    clearTimeout(timeout);
                    imageCache.set(photo, photoUrl);
                    applyImageToElement(item, photoUrl);
                    updateLoadingProgress();
                };
                
                img.onerror = function() {
                    clearTimeout(timeout);
                    if (retryCount < maxRetries) {
                        retryCount++;
                        setTimeout(attemptLoad, 1000 * retryCount);
                    } else {
                        showImageError(item);
                    }
                };
                
                // Optimize loading based on priority
                if (highPriority) {
                    img.fetchPriority = 'high';
                    img.loading = 'eager';
                } else {
                    img.fetchPriority = 'low';
                    img.loading = 'lazy';
                }
                
                img.src = photoUrl;
            }
            
            attemptLoad();
        }

        function applyImageToElement(item, imageUrl) {
            // Create preview effect first
            item.classList.add('preview');
            item.style.backgroundImage = `url('${imageUrl}')`;
            
            // Then transition to full quality
            setTimeout(() => {
                item.classList.remove('loading', 'preview');
                item.classList.add('loaded');
            }, 100);
        }

        function showImageError(item) {
            item.classList.remove('loading');
            item.classList.add('error');
            item.textContent = '💕 Beautiful Memory';
            updateLoadingProgress();
        }